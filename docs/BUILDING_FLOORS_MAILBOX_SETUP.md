# 建筑楼层、住户单元和邮箱管理系统使用指南

## 📋 概述

本系统为每个建筑自动设置楼层、住户单元和邮箱，并实现邮箱通知功能。

## 🗄️ 数据库设置（已完成）

✅ 已在 Supabase 中运行 SQL 迁移脚本，创建了以下表：
- `floors` - 楼层表
- `mailboxes` - 邮箱表
- 更新了 `households` 表（添加 `floor_id`, `floor_number`, `unit` 字段）
- 更新了 `notifications` 表（添加 `mailbox_id` 字段）

## 🚀 使用步骤

### 步骤 1: 设置建筑的楼层和单元

1. **登录应用**
   - 使用有建筑管理权限的账户登录

2. **进入建筑详情页**
   - 导航路径：`社区` → `选择社区` → `选择建筑`
   - 或直接访问：`/building/[buildingId]`

3. **设置楼层和单元**
   - 在建筑详情页的 **"概览"** 标签页
   - 找到 **"建筑设置"** 部分
   - 点击 **"设置楼层和单元"** 按钮
   - 系统会自动创建：
     - ✅ 10 层楼（1-10层）
     - ✅ 2-9 层为住户层，每层 4 个单元（A, B, C, D）
     - ✅ 每个单元对应的邮箱（共 32 个邮箱）

4. **验证设置结果**
   - 页面会自动刷新
   - 在 **"住户"** 标签页可以看到所有创建的住户单元
   - 在 **"邮箱"** 标签页可以看到所有邮箱

### 步骤 2: 管理邮箱

1. **查看邮箱列表**
   - 在建筑详情页切换到 **"邮箱"** 标签页
   - 邮箱按楼层分组显示
   - 每个邮箱显示：
     - 邮箱号码（如 "5A"）
     - 关联的住户名称
     - 是否有邮件状态
     - 最后邮件时间

2. **标记邮件到达**
   - 当有邮件到达时，建筑管理员点击对应邮箱的 **"标记有邮件"** 按钮
   - 系统会自动：
     - ✅ 更新邮箱状态为 "有邮件"
     - ✅ 记录邮件到达时间
     - ✅ 通知该住户的所有成员

### 步骤 3: 住户接收通知

1. **查看通知**
   - 住户成员登录后，在通知中心（公告板）会看到 **"📬 您有邮件"** 的通知
   - 通知内容包含：
     - 邮箱号码（如 "5A"）
     - 建筑名称
     - 提示到公共区域领取

2. **通知详情**
   - 通知类型：`MAIL_RECEIVED`
   - 标题：`📬 您有邮件`
   - 消息：`您的郵箱 {mailboxNumber} 有新的郵件。請到公共區域領取。`

## 📊 数据结构

### 楼层结构
- **1层**: 大厅（非住户层）
- **2-9层**: 住户层，每层 4 个单元（A, B, C, D）
- **10层**: 非住户层

### 住户单元命名
- 格式：`{楼层号}{单元号}`
- 示例：`2A`, `2B`, `2C`, `2D`, `3A`, `3B`, ... `9A`, `9B`, `9C`, `9D`
- 总共：8 层 × 4 单元 = 32 个住户单元

### 邮箱位置
- 所有邮箱位于 **"公共区域 - 邮箱区域"**
- 每个邮箱对应一个住户单元
- 邮箱号码与住户单元号码一致（如 "5A" 住户对应 "5A" 邮箱）

## 🔧 API 端点

### 设置楼层和单元
```
POST /api/building/[id]/floors-units/setup
```
- 需要建筑管理权限
- 自动创建所有楼层、住户单元和邮箱

### 获取邮箱列表
```
GET /api/building/[id]/mailboxes
```
- 需要建筑访问权限
- 返回该建筑的所有邮箱

### 通知住户有邮件
```
POST /api/building/[id]/mailboxes/[mailboxId]/notify
```
- 需要建筑管理权限
- 标记邮箱有邮件，并通知住户成员

## 🎯 使用场景示例

### 场景 1: 新建筑设置
1. 创建新建筑
2. 进入建筑详情页
3. 点击 "设置楼层和单元"
4. 系统自动创建所有楼层、住户和邮箱

### 场景 2: 邮件到达通知
1. 建筑管理员在邮箱区域发现 5A 住户有邮件
2. 打开应用，进入建筑详情页的 "邮箱" 标签页
3. 找到 "5A" 邮箱
4. 点击 "标记有邮件" 按钮
5. 5A 住户的所有成员收到通知

### 场景 3: 住户查看邮件通知
1. 住户成员登录应用
2. 在通知中心看到 "📬 您有邮件" 通知
3. 查看通知详情，知道是 5A 邮箱有邮件
4. 前往公共区域领取邮件

## ⚠️ 注意事项

1. **权限要求**
   - 设置楼层和单元需要建筑管理权限
   - 标记邮件需要建筑管理权限
   - 查看邮箱列表需要建筑访问权限

2. **数据安全**
   - 使用 `IF NOT EXISTS` 确保可以安全重复运行设置
   - 不会删除或修改现有数据
   - 如果住户已存在，会更新其楼层和单元信息

3. **通知机制**
   - 通知会发送给住户的所有成员
   - 通知存储在数据库中，可在通知中心查看
   - 通知包含邮箱和建筑信息

## 🐛 故障排除

### 问题：设置按钮点击后没有反应
- **检查**: 是否有建筑管理权限
- **解决**: 确保账户有管理该建筑的权限

### 问题：邮箱列表为空
- **检查**: 是否已运行设置楼层和单元
- **解决**: 在 "概览" 标签页点击 "设置楼层和单元" 按钮

### 问题：住户没有收到通知
- **检查**: 住户是否已添加到住户单元
- **检查**: 通知中心是否正确加载
- **解决**: 确保住户成员已加入该住户单元

## 📝 相关文件

- `prisma/schema.prisma` - 数据库模型定义
- `app/api/building/[id]/floors-units/setup/route.ts` - 设置 API
- `app/api/building/[id]/mailboxes/route.ts` - 邮箱列表 API
- `app/api/building/[id]/mailboxes/[mailboxId]/notify/route.ts` - 通知 API
- `components/building/MailboxManager.tsx` - 邮箱管理 UI
- `app/building/[id]/page.tsx` - 建筑详情页
- `scripts/setup-building-floors-units.ts` - 设置脚本（命令行工具）

