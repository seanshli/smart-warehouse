# Tuya Token ä¸ MQTT Broker æ¶æ„
## Tuya Token and MQTT Broker Architecture

**æœ€åæ›´æ–°**: 2025-11-21

---

## ğŸ“‹ æ¦‚è¿°

è¯´æ˜ Household/Member ä¸ Tuya Home/Tuya Member ä¹‹é—´çš„ token å…³ç³»ï¼Œä»¥åŠå¦‚ä½•ä¸ MQTT Broker é“¾æ¥ã€‚

---

## ğŸ—ï¸ Token å±‚çº§æ¶æ„

### å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Smart Warehouse                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Household "æˆ‘çš„å®¶"                                      â”‚
â”‚    â”œâ”€ tuyaHomeId: "tuya_home_xyz789"                    â”‚
â”‚    â”œâ”€ tuyaAccount: "household_xxx@smartwarehouse.local" â”‚
â”‚    â”œâ”€ tuyaPassword: "***" (åŠ å¯†)                         â”‚
â”‚    â””â”€ tuyaAccessToken: âŒ (ç›®å‰æ²¡æœ‰å­˜å‚¨)                 â”‚
â”‚                                                           â”‚
â”‚  Members:                                                 â”‚
â”‚    â”œâ”€ User A (OWNER)                                      â”‚
â”‚    â”‚   â”œâ”€ tuyaAccount: "userA@example.com"               â”‚
â”‚    â”‚   â”œâ”€ tuyaPassword: "***" (åŠ å¯†)                     â”‚
â”‚    â”‚   â”œâ”€ tuyaAccessToken: "token_abc123" (ä¸´æ—¶)         â”‚
â”‚    â”‚   â””â”€ tuyaTokenExpiresAt: "2025-11-24T12:00:00Z"    â”‚
â”‚    â”‚                                                       â”‚
â”‚    â”œâ”€ User B (USER)                                       â”‚
â”‚    â”‚   â”œâ”€ tuyaAccount: "userB@example.com"               â”‚
â”‚    â”‚   â”œâ”€ tuyaPassword: "***" (åŠ å¯†)                     â”‚
â”‚    â”‚   â”œâ”€ tuyaAccessToken: "token_def456" (ä¸´æ—¶)         â”‚
â”‚    â”‚   â””â”€ tuyaTokenExpiresAt: "2025-11-24T12:00:00Z"     â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Member ä½¿ç”¨è‡ªå·±çš„ Tuya token ç™»å½• SDK
         â”‚ ç„¶åè®¿é—® Household çš„ Tuya Home
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tuya Cloud                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Tuya Home (id: tuya_home_xyz789)                        â”‚
â”‚    â”œâ”€ Member 1 (admin) - userA@example.com              â”‚
â”‚    â”‚   â””â”€ Access Token: token_abc123                     â”‚
â”‚    â”œâ”€ Member 2 (member) - userB@example.com            â”‚
â”‚    â”‚   â””â”€ Access Token: token_def456                     â”‚
â”‚    â”œâ”€ Device 1 (é€šè¿‡ MQTT è¿æ¥)                           â”‚
â”‚    â””â”€ Device 2 (é€šè¿‡ MQTT è¿æ¥)                           â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ è®¾å¤‡é€šè¿‡ MQTT åè®®é€šä¿¡
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MQTT Broker                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  è¿æ¥è®¤è¯:                                                 â”‚
â”‚    â€¢ Username: MQTT_BROKER_USERNAME                      â”‚
â”‚    â€¢ Password: MQTT_BROKER_PASSWORD                      â”‚
â”‚    â€¢ ä¸ Tuya token æ— å…³                                   â”‚
â”‚                                                           â”‚
â”‚  MQTT ä¸»é¢˜:                                               â”‚
â”‚    â€¢ tuya/{deviceId}/status                              â”‚
â”‚    â€¢ tuya/{deviceId}/command                              â”‚
â”‚    â€¢ midea/{deviceId}/status                              â”‚
â”‚    â€¢ esp/{deviceId}/status                                â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ Token ä½¿ç”¨åœºæ™¯

### 1. Tuya SDK ç™»å½•ï¼ˆMember çº§åˆ«ï¼‰

**ç”¨é€”**: Member ç™»å½• Tuya SDK ä»¥è®¿é—® Tuya Home

**æµç¨‹**:
1. Member ä½¿ç”¨è‡ªå·±çš„ `tuyaAccount` å’Œ `tuyaPassword` ç™»å½• Tuya SDK
2. Tuya SDK è¿”å› `accessToken`ï¼ˆä¸´æ—¶ï¼Œæœ‰æœ‰æ•ˆæœŸï¼‰
3. Token ä¿å­˜åœ¨ `users.tuyaAccessToken` å’Œ `users.tuyaTokenExpiresAt`
4. ä½¿ç”¨æ­¤ token è®¿é—® Tuya Home ä¸­çš„è®¾å¤‡

**ä»£ç ä½ç½®**:
- `app/api/mqtt/tuya/login/route.ts` - è·å– Member çš„ Tuya å‡­è¯
- `lib/tuya-user-manager.ts` - ç®¡ç† Member çš„ Tuya token
- `ios/App/App/Plugins/TuyaProvisioningPlugin.swift` - iOS SDK ç™»å½•

### 2. Tuya Home è®¿é—®ï¼ˆHousehold çº§åˆ«ï¼‰

**ç”¨é€”**: è®¿é—® Household å¯¹åº”çš„ Tuya Home

**æµç¨‹**:
1. Member ç™»å½• Tuya SDKï¼ˆä½¿ç”¨è‡ªå·±çš„ tokenï¼‰
2. é€šè¿‡ `households.tuyaHomeId` è·å– Tuya Home
3. éªŒè¯ Member æ˜¯å¦æ˜¯è¯¥ Tuya Home çš„æˆå‘˜
4. å¦‚æœ Member å·²æ·»åŠ åˆ° Tuya Homeï¼Œå¯ä»¥è®¿é—®è®¾å¤‡

**ä»£ç ä½ç½®**:
- `app/api/mqtt/tuya/home/route.ts` - ç®¡ç† Tuya Home æ˜ å°„
- `lib/tuya-home-manager.ts` - Tuya Home ç®¡ç†å·¥å…·

### 3. MQTT Broker è¿æ¥ï¼ˆç‹¬ç«‹ï¼‰

**ç”¨é€”**: é€šè¿‡ MQTT åè®®ä¸è®¾å¤‡é€šä¿¡

**æµç¨‹**:
1. MQTT Broker ä½¿ç”¨ç‹¬ç«‹çš„è®¤è¯ï¼ˆ`MQTT_BROKER_USERNAME`/`PASSWORD`ï¼‰
2. ä¸ Tuya token **æ— å…³**
3. è®¾å¤‡é€šè¿‡ MQTT ä¸»é¢˜å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯
4. ä¸»é¢˜æ ¼å¼ï¼š`{vendor}/{deviceId}/{status|command}`

**ä»£ç ä½ç½®**:
- `lib/mqtt-client.ts` - MQTT å®¢æˆ·ç«¯
- `app/api/mqtt/iot/devices/[id]/control/route.ts` - è®¾å¤‡æ§åˆ¶

---

## âš ï¸ å½“å‰é—®é¢˜

### é—®é¢˜ 1: Token ä¸ MQTT çš„å…³è”

**ç°çŠ¶**:
- Tuya token ç”¨äº SDK ç™»å½•å’Œé…ç½‘
- MQTT Broker ä½¿ç”¨ç‹¬ç«‹çš„è®¤è¯
- **ä¸¤è€…æ²¡æœ‰ç›´æ¥å…³è”**

**å½±å“**:
- è®¾å¤‡é…ç½‘åï¼Œé€šè¿‡ MQTT é€šä¿¡
- ä½† MQTT ä¸éªŒè¯ Tuya token
- å¯èƒ½å¯¼è‡´å®‰å…¨é—®é¢˜

### é—®é¢˜ 2: Household Token ç¼ºå¤±

**ç°çŠ¶**:
- Household æœ‰ `tuyaAccount` å’Œ `tuyaPassword`
- ä½†æ²¡æœ‰ `tuyaAccessToken` å’Œ `tuyaTokenExpiresAt`
- Household è´¦æˆ·å¯èƒ½æ— æ³•ç›´æ¥ç™»å½•

**å½±å“**:
- å¦‚æœä½¿ç”¨ Household è´¦æˆ·ï¼Œéœ€è¦æ¯æ¬¡ç™»å½•
- æ— æ³•æŒä¹…åŒ– token

### é—®é¢˜ 3: Token åŒæ­¥

**ç°çŠ¶**:
- Member çš„ token å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- ä½†è®¾å¤‡ç«¯ï¼ˆiOS/Androidï¼‰çš„ token å­˜å‚¨åœ¨æœ¬åœ°
- **ä¸¤è€…å¯èƒ½ä¸åŒæ­¥**

**å½±å“**:
- è®¾å¤‡ç«¯ token è¿‡æœŸåï¼Œéœ€è¦é‡æ–°ç™»å½•
- æ•°æ®åº“ä¸­çš„ token å¯èƒ½å·²è¿‡æœŸ

---

## ğŸ”§ å»ºè®®çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ç»Ÿä¸€ Token ç®¡ç†ï¼ˆæ¨èï¼‰

**å®ç°**:
1. Member ç™»å½• Tuya SDK åï¼Œå°† token ä¿å­˜åˆ°æ•°æ®åº“
2. è®¾å¤‡æ§åˆ¶æ—¶ï¼Œæ£€æŸ¥ token æœ‰æ•ˆæ€§
3. å¦‚æœ token è¿‡æœŸï¼Œè‡ªåŠ¨é‡æ–°ç™»å½•
4. MQTT Broker ä¿æŒç‹¬ç«‹è®¤è¯ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰

**ä¼˜ç‚¹**:
- âœ… Token é›†ä¸­ç®¡ç†
- âœ… è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- âœ… è·¨è®¾å¤‡åŒæ­¥

### æ–¹æ¡ˆ 2: MQTT ä¸»é¢˜æƒé™æ§åˆ¶

**å®ç°**:
1. åœ¨ MQTT Broker ä¸­é…ç½® ACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰
2. æ ¹æ® Member çš„ Household æˆå‘˜å…³ç³»æ§åˆ¶ä¸»é¢˜è®¿é—®
3. ä¸»é¢˜æ ¼å¼ï¼š`{householdId}/{vendor}/{deviceId}/...`

**ä¼˜ç‚¹**:
- âœ… ç»†ç²’åº¦æƒé™æ§åˆ¶
- âœ… å®‰å…¨æ€§æ›´é«˜

### æ–¹æ¡ˆ 3: æ··åˆæ¨¡å¼

**å®ç°**:
1. Tuya SDK ä½¿ç”¨ Member tokenï¼ˆç”¨äºé…ç½‘å’Œæ§åˆ¶ï¼‰
2. MQTT Broker ä½¿ç”¨ç‹¬ç«‹è®¤è¯ï¼ˆç”¨äºè®¾å¤‡é€šä¿¡ï¼‰
3. åœ¨ MQTT æ¶ˆæ¯ä¸­åŒ…å« Member ID ç”¨äºå®¡è®¡

**ä¼˜ç‚¹**:
- âœ… çµæ´»æ€§é«˜
- âœ… å®‰å…¨æ€§å¥½

---

## ğŸ“ å½“å‰å·¥ä½œæµç¨‹

### é…ç½‘æµç¨‹

```
1. Member ç™»å½• Tuya SDKï¼ˆä½¿ç”¨è‡ªå·±çš„ tokenï¼‰
   â†“
2. é€‰æ‹© Householdï¼ˆé€šè¿‡ tuyaHomeIdï¼‰
   â†“
3. å¼€å§‹é…ç½‘ï¼ˆè®¾å¤‡è¿æ¥åˆ° MQTT Brokerï¼‰
   â†“
4. è®¾å¤‡æ·»åŠ åˆ° Tuya Home
   â†“
5. è®¾å¤‡ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆåŒ…æ‹¬ MQTT ä¸»é¢˜ï¼‰
```

### æ§åˆ¶æµç¨‹

```
1. Member è¯·æ±‚æ§åˆ¶è®¾å¤‡
   â†“
2. éªŒè¯ Member æ˜¯ Household çš„æˆå‘˜
   â†“
3. æ£€æŸ¥ Member çš„ Tuya token æœ‰æ•ˆæ€§
   â†“
4. å¦‚æœæ— æ•ˆï¼Œé‡æ–°ç™»å½•è·å–æ–° token
   â†“
5. é€šè¿‡ MQTT å‘é€æ§åˆ¶å‘½ä»¤ï¼ˆä½¿ç”¨ MQTT Broker è®¤è¯ï¼‰
   â†“
6. è®¾å¤‡å“åº”ï¼ˆé€šè¿‡ MQTT ä¸»é¢˜ï¼‰
```

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `lib/tuya-user-manager.ts` - Member Tuya token ç®¡ç†
- `lib/tuya-household-manager.ts` - Household Tuya è´¦æˆ·ç®¡ç†
- `lib/mqtt-client.ts` - MQTT Broker è¿æ¥
- `app/api/mqtt/tuya/login/route.ts` - Tuya ç™»å½• API
- `app/api/mqtt/iot/devices/[id]/control/route.ts` - è®¾å¤‡æ§åˆ¶ API

---

## âœ… æ€»ç»“

**å½“å‰çŠ¶æ€**:
- âœ… Member æœ‰è‡ªå·±çš„ Tuya tokenï¼ˆå­˜å‚¨åœ¨æ•°æ®åº“ï¼‰
- âœ… Household æœ‰ Tuya è´¦æˆ·ï¼ˆä½†ç¼ºå°‘ tokenï¼‰
- âœ… MQTT Broker ä½¿ç”¨ç‹¬ç«‹è®¤è¯
- âš ï¸ Token ä¸ MQTT æ²¡æœ‰ç›´æ¥å…³è”
- âš ï¸ Token åŒæ­¥å¯èƒ½å­˜åœ¨é—®é¢˜

**å»ºè®®**:
1. å®ç°è‡ªåŠ¨ token åˆ·æ–°æœºåˆ¶
2. åœ¨è®¾å¤‡æ§åˆ¶æ—¶éªŒè¯ token æœ‰æ•ˆæ€§
3. è€ƒè™‘æ·»åŠ  Household çº§åˆ«çš„ token ç®¡ç†
4. å®ç° MQTT ä¸»é¢˜æƒé™æ§åˆ¶ï¼ˆå¯é€‰ï¼‰

---

