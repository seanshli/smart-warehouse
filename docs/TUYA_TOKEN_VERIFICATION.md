# Tuya Token éªŒè¯æŒ‡å—
## Tuya Token Verification Guide

**æœ€åæ›´æ–°**: 2025-11-21

---

## ğŸ“‹ éªŒè¯æ¸…å•

### 1. æ•°æ®åº“ç»“æ„éªŒè¯

**æ£€æŸ¥å­—æ®µ**:
- `tuyaAccount` - Tuya è´¦æˆ·ï¼ˆé‚®ç®±æˆ–æ‰‹æœºå·ï¼‰
- `tuyaPassword` - Tuya å¯†ç ï¼ˆbcrypt åŠ å¯†ï¼‰
- `tuyaCountryCode` - å›½å®¶ä»£ç 
- `tuyaAccessToken` - è®¿é—®ä»¤ç‰Œ
- `tuyaTokenExpiresAt` - ä»¤ç‰Œè¿‡æœŸæ—¶é—´

**éªŒè¯æ–¹æ³•**:
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'users' 
AND column_name LIKE 'tuya%';
```

---

### 2. Token ç®¡ç†å‡½æ•°éªŒè¯

#### 2.1 `saveTuyaAccessToken()`
- **åŠŸèƒ½**: ä¿å­˜ Tuya access token å’Œè¿‡æœŸæ—¶é—´
- **å‚æ•°**: `userId`, `accessToken`, `expiresAt`
- **è¿”å›**: `boolean`

#### 2.2 `isTuyaTokenValid()`
- **åŠŸèƒ½**: æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆï¼ˆæœªè¿‡æœŸï¼‰
- **å‚æ•°**: `userId`
- **è¿”å›**: `boolean`

#### 2.3 `getUserTuyaAccount()`
- **åŠŸèƒ½**: è·å–ç”¨æˆ·çš„ Tuya è´¦æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…å«å¯†ç ï¼‰
- **å‚æ•°**: `userId`
- **è¿”å›**: `{ tuyaAccount, tuyaCountryCode, hasAccount }`

#### 2.4 `getUserTuyaCredentials()`
- **åŠŸèƒ½**: è·å–ç”¨æˆ·çš„ Tuya è´¦æˆ·å’Œå¯†ç ï¼ˆç”¨äºç™»å½•ï¼‰
- **å‚æ•°**: `userId`
- **è¿”å›**: `{ tuyaAccount, tuyaPassword, tuyaCountryCode }`
- **æ³¨æ„**: å¯†ç æ˜¯åŠ å¯†çš„ï¼Œéœ€è¦åœ¨å®¢æˆ·ç«¯é€šè¿‡ SDK å¤„ç†

---

### 3. API ç«¯ç‚¹éªŒè¯

#### 3.1 GET `/api/user/tuya-account`
- **åŠŸèƒ½**: è·å–å½“å‰ç”¨æˆ·çš„ Tuya è´¦æˆ·ä¿¡æ¯
- **è¿”å›**: `{ hasTuyaAccount, tuyaAccount (masked), tuyaCountryCode }`

#### 3.2 POST `/api/user/tuya-account/auto-create`
- **åŠŸèƒ½**: è‡ªåŠ¨åˆ›å»º Tuya è´¦æˆ·
- **è¿”å›**: `{ success, alreadyExists, tuyaAccount (masked) }`

#### 3.3 POST `/api/mqtt/tuya/login`
- **åŠŸèƒ½**: è·å– Tuya ç™»å½•å‡­è¯
- **è¿”å›**: `{ success, countryCode, account, hasPassword }`

#### 3.4 GET `/api/mqtt/tuya/login-status`
- **åŠŸèƒ½**: æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆWeb åå¤‡ï¼‰
- **è¿”å›**: `{ loggedIn, message }`

---

### 4. Token æµç¨‹éªŒè¯

#### 4.1 è´¦æˆ·åˆ›å»ºæµç¨‹
1. ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨ Tuya åŠŸèƒ½
2. ç³»ç»Ÿæ£€æŸ¥æ˜¯å¦æœ‰ Tuya è´¦æˆ·
3. å¦‚æœæ²¡æœ‰ï¼Œè‡ªåŠ¨åˆ›å»ºè´¦æˆ·ï¼ˆç”Ÿæˆé‚®ç®±å’Œå¯†ç ï¼‰
4. å¯†ç åŠ å¯†å­˜å‚¨åˆ°æ•°æ®åº“

#### 4.2 ç™»å½•æµç¨‹
1. SDK åˆå§‹åŒ–
2. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
3. å¦‚æœæœªç™»å½•ï¼Œè·å–ç”¨æˆ·å‡­è¯
4. ä½¿ç”¨ SDK çš„ `login()` æˆ– `loginOrRegister()` ç™»å½•
5. ç™»å½•æˆåŠŸåï¼ŒSDK è¿”å› access token
6. Token ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰

#### 4.3 Token éªŒè¯æµç¨‹
1. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰ token
2. æ£€æŸ¥ token æ˜¯å¦è¿‡æœŸ
3. å¦‚æœè¿‡æœŸï¼Œé‡æ–°ç™»å½•

---

## ğŸ”§ ä½¿ç”¨éªŒè¯è„šæœ¬

### è¿è¡ŒéªŒè¯è„šæœ¬

```bash
npm run verify:tuya-token
```

**è„šæœ¬ä¼šæ£€æŸ¥**:
- âœ… æ•°æ®åº“ç»“æ„ï¼ˆtoken å­—æ®µï¼‰
- âœ… Token ç®¡ç†å‡½æ•°
- âœ… Token æœ‰æ•ˆæ€§æ£€æŸ¥
- âœ… API ç«¯ç‚¹æµ‹è¯•
- âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥
- âœ… SDK é…ç½®éªŒè¯

---

## âš ï¸ é‡è¦å‘ç°

### å¯†ç åŠ å¯†
- **å­˜å‚¨æ–¹å¼**: Tuya å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨
- **åŠ å¯†å¼ºåº¦**: Salt rounds = 12
- **è§£å¯†**: å¯†ç ä¸éœ€è¦è§£å¯†ï¼ŒSDK ä½¿ç”¨åŠ å¯†åçš„å¯†ç è¿›è¡ŒéªŒè¯
- **æ³¨æ„**: `getUserTuyaCredentials()` è¿”å›çš„æ˜¯åŠ å¯†åçš„å¯†ç ï¼ŒSDK ä¼šå¤„ç†

### Token å­˜å‚¨
- **å­—æ®µ**: `tuyaAccessToken` å’Œ `tuyaTokenExpiresAt`
- **è¿‡æœŸæ£€æŸ¥**: é€šè¿‡ `isTuyaTokenValid()` æ£€æŸ¥
- **è‡ªåŠ¨æ¸…ç†**: æ›´æ–°è´¦æˆ·æ—¶è‡ªåŠ¨æ¸…é™¤ token

### SDK é›†æˆ
- **iOS**: ä½¿ç”¨ `ThingSmartUser.sharedInstance()` è¿›è¡Œç™»å½•
- **Android**: å¾…å®ç°
- **Web**: ä½¿ç”¨ API åå¤‡æ–¹æ¡ˆ

---

## ğŸ› å¸¸è§é—®é¢˜

### Token è¿‡æœŸ
**é—®é¢˜**: Token å·²è¿‡æœŸï¼Œä½†ç³»ç»Ÿä»åœ¨ä½¿ç”¨

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `isTuyaTokenValid()` å‡½æ•°
2. ç¡®ä¿åœ¨æ¯æ¬¡ä½¿ç”¨å‰æ£€æŸ¥ token æœ‰æ•ˆæ€§
3. å¦‚æœè¿‡æœŸï¼Œé‡æ–°ç™»å½•

### å¯†ç éªŒè¯å¤±è´¥
**é—®é¢˜**: å¯†ç éªŒè¯å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®åŠ å¯†
2. æ£€æŸ¥ `verifyTuyaPassword()` å‡½æ•°
3. ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å¯†ç è¿›è¡ŒéªŒè¯

### Token æœªä¿å­˜
**é—®é¢˜**: Token æœªä¿å­˜åˆ°æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `saveTuyaAccessToken()` å‡½æ•°
2. ç¡®ä¿æ•°æ®åº“å­—æ®µå­˜åœ¨
3. æ£€æŸ¥æƒé™å’Œé”™è¯¯æ—¥å¿—

---

## âœ… éªŒè¯æˆåŠŸæ ‡å‡†

### æ•°æ®åº“
- âœ… æ‰€æœ‰ Tuya å­—æ®µå­˜åœ¨
- âœ… å­—æ®µç±»å‹æ­£ç¡®
- âœ… å¯ä»¥å­˜å‚¨å’Œè¯»å–æ•°æ®

### Token ç®¡ç†
- âœ… å¯ä»¥ä¿å­˜ token
- âœ… å¯ä»¥æ£€æŸ¥ token æœ‰æ•ˆæ€§
- âœ… å¯ä»¥è·å–ç”¨æˆ·å‡­è¯

### API ç«¯ç‚¹
- âœ… æ‰€æœ‰ç«¯ç‚¹å¯ç”¨
- âœ… è¿”å›æ­£ç¡®çš„æ•°æ®æ ¼å¼
- âœ… é”™è¯¯å¤„ç†æ­£ç¡®

### SDK é…ç½®
- âœ… ç¯å¢ƒå˜é‡å·²è®¾ç½®
- âœ… SDK é…ç½® API å¯ç”¨
- âœ… å¯ä»¥è·å– SDK å‡­è¯

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```
æµ‹è¯•æ—¥æœŸ: [æ—¥æœŸ]
æµ‹è¯•å¹³å°: [iOS/Android/Web]
æµ‹è¯•äººå‘˜: [å§“å]

æ•°æ®åº“ç»“æ„:
- [ ] tuyaAccount å­—æ®µ: [é€šè¿‡/å¤±è´¥]
- [ ] tuyaPassword å­—æ®µ: [é€šè¿‡/å¤±è´¥]
- [ ] tuyaAccessToken å­—æ®µ: [é€šè¿‡/å¤±è´¥]
- [ ] tuyaTokenExpiresAt å­—æ®µ: [é€šè¿‡/å¤±è´¥]

Token ç®¡ç†å‡½æ•°:
- [ ] saveTuyaAccessToken(): [é€šè¿‡/å¤±è´¥]
- [ ] isTuyaTokenValid(): [é€šè¿‡/å¤±è´¥]
- [ ] getUserTuyaAccount(): [é€šè¿‡/å¤±è´¥]
- [ ] getUserTuyaCredentials(): [é€šè¿‡/å¤±è´¥]

API ç«¯ç‚¹:
- [ ] GET /api/user/tuya-account: [é€šè¿‡/å¤±è´¥]
- [ ] POST /api/user/tuya-account/auto-create: [é€šè¿‡/å¤±è´¥]
- [ ] POST /api/mqtt/tuya/login: [é€šè¿‡/å¤±è´¥]
- [ ] GET /api/mqtt/tuya/login-status: [é€šè¿‡/å¤±è´¥]

SDK é…ç½®:
- [ ] ç¯å¢ƒå˜é‡: [é€šè¿‡/å¤±è´¥]
- [ ] SDK Config API: [é€šè¿‡/å¤±è´¥]

é—®é¢˜è®°å½•:
[è®°å½•ä»»ä½•å‘ç°çš„é—®é¢˜]

å¤‡æ³¨:
[å…¶ä»–å¤‡æ³¨]
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. è¿è¡ŒéªŒè¯è„šæœ¬: `npm run verify:tuya-token`
2. æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•é”™è¯¯
3. åœ¨ç§»åŠ¨åº”ç”¨ä¸­æµ‹è¯•å®Œæ•´æµç¨‹
4. éªŒè¯ token è¿‡æœŸå¤„ç†
5. æµ‹è¯•è‡ªåŠ¨è´¦æˆ·åˆ›å»ºå’Œç™»å½•

