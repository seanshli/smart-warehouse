generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String               @id @default(dbgenerated("(gen_random_uuid())::text"))
  email                String               @unique
  name                 String?
  image                String?
  phone                String?
  contact              String?
  language             String?              @default("en")
  isAdmin              Boolean              @default(false)
  adminRole            String?              @default("SUPERUSER") @map("admin_role") // SUPERUSER, USER_MANAGEMENT, ITEM_MANAGEMENT, HOUSEHOLD_MODIFICATION
  preferences          Json? // User preferences: theme, fontSize, language
  forcePasswordChange  Boolean?             @default(false) @map("force_password_change")
  // Tuya account integration (per member)
  tuyaAccount          String?              @map("tuya_account") // Tuya account (email or phone number)
  tuyaPassword         String?              @map("tuya_password") // Encrypted Tuya password
  tuyaCountryCode      String?              @default("886") @map("tuya_country_code") // Country code for Tuya login (e.g., "886" for Taiwan, "86" for China)
  tuyaAccessToken      String?              @map("tuya_access_token") // Tuya access token (encrypted, temporary)
  tuyaTokenExpiresAt   DateTime?            @map("tuya_token_expires_at") @db.Timestamptz(6) // Token expiration time
  createdAt            DateTime?            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime?            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  accounts             Account[]
  barcodes             Barcode[]
  householdMemberships HouseholdMember[]
  communityMemberships CommunityMember[]
  buildingMemberships  BuildingMember[]
  workingGroupMembers  WorkingGroupMember[]
  joinRequests         JoinRequest[]
  itemHistory          ItemHistory[]
  items                Item[]
  notifications        Notification[]
  sessions             Session[]
  credentials          UserCredentials?
  activities           UserActivity[]
  announcements        Announcement[]
  announcementReads    AnnouncementRead[]
  conversationsCreated Conversation[]       @relation("ConversationCreator")
  messagesSent         Message[]            @relation("MessageSender")
  callsInitiated       CallSession[]        @relation("CallInitiator")

  @@map("users")
}

model Account {
  id                  String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id             String
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  users               User    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([provider, provider_account_id])
  @@map("accounts")
}

model Session {
  id            String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  session_token String   @unique
  user_id       String
  expires       DateTime @db.Timestamptz(6)
  users         User     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime @db.Timestamptz(6)

  @@id([identifier, token])
  @@map("verification_tokens")
}

model Community {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  name           String
  description    String?
  address        String?
  city           String?
  district       String?
  country        String?
  latitude       Float?
  longitude      Float?
  invitationCode String?   @unique @default(dbgenerated("(gen_random_uuid())::text")) @map("invitation_code")
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  buildings     Building[]
  members       CommunityMember[]
  workingGroups WorkingGroup[]

  @@map("communities")
}

model Building {
  id                     String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  communityId            String    @map("community_id")
  name                   String
  description            String?
  address                String?
  floorCount             Int?      @map("floor_count")
  unitCount              Int?      @map("unit_count")
  latitude               Float?
  longitude              Float?
  invitationCode         String?   @unique @default(dbgenerated("(gen_random_uuid())::text")) @map("invitation_code")
  doorbellTimeoutSeconds Int?      @default(30) @map("doorbell_timeout_seconds") // Timeout in seconds before routing to front desk
  createdAt              DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  community      Community        @relation(fields: [communityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  households     Household[]
  members        BuildingMember[]
  floors         Floor[]
  mailboxes      Mailbox[]
  doorBells      DoorBell[]
  packageLockers PackageLocker[]
  packages       Package[]
  facilities     Facility[]
  doorUnlockLogs DoorUnlockLog[]
  conversations  Conversation[]
  conversations  Conversation[]
  Conversation   Conversation[]

  @@map("buildings")
}

model CommunityMember {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId       String    @map("user_id")
  communityId  String    @map("community_id")
  role         String?   @default("MEMBER") // ADMIN, MANAGER, MEMBER, VIEWER
  memberClass  String?   @default("household") @map("member_class") // household, building, community - distinguishes residents from working team
  joinedAt     DateTime? @default(now()) @map("joined_at") @db.Timestamptz(6)
  // Auto-joined members (from Building/Household) have limited permissions
  isAutoJoined Boolean?  @default(false) @map("is_auto_joined")

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, communityId])
  @@map("community_members")
}

model BuildingMember {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId       String    @map("user_id")
  buildingId   String    @map("building_id")
  role         String?   @default("MEMBER") // ADMIN, MANAGER, MEMBER, VIEWER
  memberClass  String?   @default("household") @map("member_class") // household, building, community - distinguishes residents from working team
  joinedAt     DateTime? @default(now()) @map("joined_at") @db.Timestamptz(6)
  // Auto-joined members (from Household) have limited permissions
  isAutoJoined Boolean?  @default(false) @map("is_auto_joined")

  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, buildingId])
  @@map("building_members")
}

model WorkingGroup {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  communityId String    @map("community_id")
  name        String
  description String?
  type        String // BUILDING_MANAGER, SECURITY, MAINTENANCE, ADMINISTRATION, etc.
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  community   Community                @relation(fields: [communityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  members     WorkingGroupMember[]
  permissions WorkingGroupPermission[]

  @@map("working_groups")
}

model WorkingGroupMember {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  workingGroupId String    @map("working_group_id")
  userId         String    @map("user_id")
  role           String?   @default("MEMBER") // LEADER, MEMBER
  assignedAt     DateTime? @default(now()) @map("assigned_at") @db.Timestamptz(6)

  workingGroup WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([workingGroupId, userId])
  @@map("working_group_members")
}

model WorkingGroupPermission {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  workingGroupId String    @map("working_group_id")
  permission     String // VIEW, EDIT, ADD, REMOVE, ADD_MEMBER, REVOKE_MEMBER, MANAGE_BUILDING, etc.
  scope          String? // ALL_BUILDINGS, SPECIFIC_BUILDING, SPECIFIC_HOUSEHOLD
  scopeId        String?   @map("scope_id") // Building ID or Household ID if scope is specific
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  workingGroup WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([workingGroupId, permission, scope, scopeId])
  @@map("working_group_permissions")
}

model Household {
  id                   String                @id @default(dbgenerated("(gen_random_uuid())::text"))
  name                 String
  description          String?
  invitationCode       String?               @unique @default(dbgenerated("(gen_random_uuid())::text")) @map("invitation_code")
  // Tuya Home integration
  tuyaHomeId           String?               @unique @map("tuya_home_id") // Tuya Home ID (對應到 Tuya SDK 的 Home)
  tuyaAccount          String?               @map("tuya_account") // Tuya account for this household (email or phone)
  tuyaPassword         String?               @map("tuya_password") // Encrypted Tuya password for household
  tuyaCountryCode      String?               @default("886") @map("tuya_country_code") // Country code for Tuya household account
  tuyaAccessToken      String?               @map("tuya_access_token") // Tuya access token for household (temporary, encrypted)
  tuyaTokenExpiresAt   DateTime?             @map("tuya_token_expires_at") @db.Timestamptz(6) // Token expiration time for household
  // Building relationship (new)
  buildingId           String?               @map("building_id")
  floorId              String?               @map("floor_id") // Floor ID (e.g., floor 2-9)
  floorNumber          Int?                  @map("floor_number") // Floor number (2-9)
  unit                 String? // Unit identifier (A, B, C, D)
  // Location fields
  country              String?
  city                 String?
  district             String?
  community            String? // Legacy field, kept for backward compatibility
  apartmentNo          String?               @map("apartment_no")
  latitude             Float?
  longitude            Float?
  address              String?
  streetAddress        String?               @map("street_address")
  buildingAddress      String?               @map("building_address")
  telephone            String?
  createdAt            DateTime?             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime?             @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  categories           Category[]
  members              HouseholdMember[]
  items                Item[]
  rooms                Room[]
  activities           UserActivity[]
  iotDevices           IoTDevice[] // IoT 設備（統一支援 MQTT 和 RESTful API）
  building             Building?             @relation(fields: [buildingId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  floor                Floor?                @relation(fields: [floorId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  mailboxes            Mailbox[] // Mailboxes linked to this household
  doorBells            DoorBell[] // Door bells linked to this household
  packages             Package[] // Packages for this household
  facilityReservations FacilityReservation[] // Facility reservations by this household
  automationRules      AutomationRule[] // 跨生态链控制规则
  scenes               Scene[] // 场景管理
  announcementReads    AnnouncementRead[] // Announcements read by this household
  conversations        Conversation[] // Conversations with frontdesk/admin

  @@map("households")
}

model HouseholdMember {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId      String    @map("user_id")
  householdId String    @map("household_id")
  role        String?   @default("USER")
  joinedAt    DateTime? @default(now()) @map("joined_at") @db.Timestamptz(6)
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, householdId])
  @@map("household_members")
}

model JoinRequest {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId      String    @map("user_id")
  type        String // 'community' | 'building' | 'household'
  targetId    String    @map("target_id") // Community/Building/Household ID
  status      String    @default("pending") // 'pending' | 'approved' | 'rejected'
  message     String? // Optional message from requester
  requestedAt DateTime? @default(now()) @map("requested_at") @db.Timestamptz(6)
  reviewedAt  DateTime? @map("reviewed_at") @db.Timestamptz(6)
  reviewedBy  String?   @map("reviewed_by") // User ID who reviewed the request
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, type, targetId, status])
  @@index([type, targetId, status])
  @@map("join_requests")
}

model Room {
  id             String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name           String
  description    String?
  householdId    String         @map("household_id")
  createdAt      DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  cabinets       Cabinet[]
  newItemHistory ItemHistory[]  @relation("ItemHistoryNewRoom")
  oldItemHistory ItemHistory[]  @relation("ItemHistoryOldRoom")
  items          Item[]
  activities     UserActivity[]
  iotDevices     IoTDevice[] // IoT 設備（統一支援 MQTT 和 RESTful API）
  household      Household      @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("rooms")
}

model Cabinet {
  id             String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name           String
  description    String?
  roomId         String         @map("room_id")
  createdAt      DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  room           Room           @relation(fields: [roomId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  newItemHistory ItemHistory[]  @relation("ItemHistoryNewCabinet")
  oldItemHistory ItemHistory[]  @relation("ItemHistoryOldCabinet")
  items          Item[]
  activities     UserActivity[]

  @@map("cabinets")
}

model Category {
  id          String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name        String
  description String?
  level       Int
  parentId    String?        @map("parent_id")
  householdId String         @map("household_id")
  createdAt   DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  household   Household      @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  parent      Category?      @relation("CategoryHierarchy", fields: [parentId], references: [id], onUpdate: NoAction)
  children    Category[]     @relation("CategoryHierarchy")
  items       Item[]
  activities  UserActivity[]

  @@map("categories")
}

model Item {
  id            String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name          String
  description   String?
  quantity      Int            @default(1)
  minQuantity   Int?           @default(0) @map("min_quantity")
  image_url     String?
  barcode       String?
  qr_code       String?
  categoryId    String?        @map("category_id")
  roomId        String?        @map("room_id")
  cabinetId     String?        @map("cabinet_id")
  householdId   String         @map("household_id")
  addedById     String         @map("added_by_id")
  createdAt     DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  qrCode        String?
  imageUrl      String?
  aiDescription String?
  language      String?        @map("language")
  buyDate       DateTime?      @map("buy_date") @db.Timestamp(6)
  buyCost       Float?         @map("buy_cost") @db.Real
  buyLocation   String?        @map("buy_location")
  invoiceNumber String?        @map("invoice_number")
  sellerName    String?        @map("seller_name")
  tags          String[]       @default([])
  history       ItemHistory[]
  addedBy       User           @relation(fields: [addedById], references: [id], onDelete: Cascade, onUpdate: NoAction)
  cabinet       Cabinet?       @relation(fields: [cabinetId], references: [id], onUpdate: NoAction)
  category      Category?      @relation(fields: [categoryId], references: [id], onUpdate: NoAction)
  household     Household      @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  room          Room?          @relation(fields: [roomId], references: [id], onUpdate: NoAction)
  notifications Notification[]
  activities    UserActivity[]

  @@map("items")
}

model ItemHistory {
  id              String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  itemId          String    @map("item_id")
  action          String
  description     String?
  voiceUrl        String?   @map("voice_url")
  voiceTranscript String?   @map("voice_transcript")
  performedBy     String    @map("performed_by")
  oldRoomId       String?   @map("old_room_id")
  newRoomId       String?   @map("new_room_id")
  oldCabinetId    String?   @map("old_cabinet_id")
  newCabinetId    String?   @map("new_cabinet_id")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  item            Item      @relation(fields: [itemId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  newCabinet      Cabinet?  @relation("ItemHistoryNewCabinet", fields: [newCabinetId], references: [id], onUpdate: NoAction)
  newRoom         Room?     @relation("ItemHistoryNewRoom", fields: [newRoomId], references: [id], onUpdate: NoAction)
  oldCabinet      Cabinet?  @relation("ItemHistoryOldCabinet", fields: [oldCabinetId], references: [id], onUpdate: NoAction)
  oldRoom         Room?     @relation("ItemHistoryOldRoom", fields: [oldRoomId], references: [id], onUpdate: NoAction)
  performer       User      @relation(fields: [performedBy], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("item_history")
}

model UserActivity {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId       String    @map("user_id")
  householdId  String    @map("household_id")
  activityType String    @map("activity_type") // 'search', 'view_item', 'view_location', 'view_category', 'navigate', 'filter', etc.
  action       String // 'search_items', 'view_item_detail', 'view_room', 'view_cabinet', 'view_category', 'filter_by_category', etc.
  metadata     Json? // Store search query, item ID, location ID, category ID, filter params, etc.
  description  String? // Human-readable description
  itemId       String?   @map("item_id")
  roomId       String?   @map("room_id")
  cabinetId    String?   @map("cabinet_id")
  categoryId   String?   @map("category_id")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  household    Household @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  item         Item?     @relation(fields: [itemId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  room         Room?     @relation(fields: [roomId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  cabinet      Cabinet?  @relation(fields: [cabinetId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  category     Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([userId, householdId, createdAt])
  @@index([householdId, activityType, createdAt])
  @@map("user_activities")
}

model Barcode {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id      String
  barcode      String
  product_name String?
  description  String?
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  users        User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("barcodes")
}

model Notification {
  id                    String               @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId                String               @map("user_id")
  itemId                String?              @map("item_id")
  mailboxId             String?              @map("mailbox_id") // Mailbox ID for mail notifications
  doorBellId            String?              @map("door_bell_id") // Door bell ID for door bell notifications
  packageId             String?              @map("package_id") // Package ID for package notifications
  facilityReservationId String?              @map("facility_reservation_id") // Facility reservation ID
  type                  String
  title                 String
  message               String
  read                  Boolean?             @default(false)
  createdAt             DateTime?            @default(now()) @map("created_at") @db.Timestamptz(6)
  item                  Item?                @relation(fields: [itemId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  mailbox               Mailbox?             @relation(fields: [mailboxId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  doorBell              DoorBell?            @relation(fields: [doorBellId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  package               Package?             @relation(fields: [packageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  facilityReservation   FacilityReservation? @relation(fields: [facilityReservationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("notifications")
}

model Floor {
  id            String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  buildingId    String    @map("building_id")
  floorNumber   Int       @map("floor_number") // Floor number (1-10, where 2-9 are residential)
  name          String? // Optional floor name
  description   String? // Floor description
  isResidential Boolean?  @default(false) @map("is_residential") // True for floors 2-9
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  building   Building    @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  households Household[]
  mailboxes  Mailbox[]
  facilities Facility[]

  @@unique([buildingId, floorNumber])
  @@map("floors")
}

model Mailbox {
  id            String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  buildingId    String    @map("building_id")
  floorId       String?   @map("floor_id")
  householdId   String?   @map("household_id") // Linked household (e.g., 5A)
  mailboxNumber String    @map("mailbox_number") // Display number (e.g., "5A")
  location      String? // Location description (e.g., "Common Area - Mailbox Section A")
  hasMail       Boolean?  @default(false) @map("has_mail") // Whether there's mail waiting
  lastMailAt    DateTime? @map("last_mail_at") @db.Timestamptz(6) // Last time mail was received
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  building      Building       @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  floor         Floor?         @relation(fields: [floorId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  household     Household?     @relation(fields: [householdId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  notifications Notification[]

  @@unique([buildingId, mailboxNumber])
  @@map("mailboxes")
}

// Front Door Door Bell - Similar to Mailbox, triggers alarm to household
model DoorBell {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  buildingId     String    @map("building_id")
  householdId    String?   @map("household_id") // Linked household
  doorBellNumber String    @map("door_bell_number") // Display number (e.g., "3A")
  location       String?   @default("Front Door") // Location description
  isEnabled      Boolean?  @default(true) @map("is_enabled") // Whether door bell is enabled
  lastRungAt     DateTime? @map("last_rung_at") @db.Timestamptz(6) // Last time door bell was rung
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  building      Building       @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  household     Household?     @relation(fields: [householdId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  notifications Notification[]

  callSessions DoorBellCallSession[]

  @@unique([buildingId, doorBellNumber])
  @@map("door_bells")
}

// Door Bell Call Session - Tracks active calls between guests and households
model DoorBellCallSession {
  id                String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  doorBellId        String    @map("door_bell_id")
  status            String    @default("ringing") // ringing, connected, ended
  startedAt         DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  connectedAt       DateTime? @map("connected_at") @db.Timestamptz(6)
  endedAt           DateTime? @map("ended_at") @db.Timestamptz(6)
  routedToFrontDesk Boolean   @default(false) @map("routed_to_frontdesk") // Whether call was routed to front desk
  routedAt          DateTime? @map("routed_at") @db.Timestamptz(6) // When call was routed to front desk
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  doorBell DoorBell          @relation(fields: [doorBellId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  messages DoorBellMessage[]

  @@map("door_bell_call_sessions")
}

// Door Bell Message - Chat messages during call
model DoorBellMessage {
  id            String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  callSessionId String    @map("call_session_id")
  from          String // 'guest' or 'household'
  message       String
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  callSession DoorBellCallSession @relation(fields: [callSessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("door_bell_messages")
}

// Door Unlock Log - Track door unlock events
model DoorUnlockLog {
  id         String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  buildingId String    @map("building_id")
  doorBellId String?   @map("door_bell_id")
  unlockedBy String    @map("unlocked_by") // User ID
  unlockedAt DateTime  @default(now()) @map("unlocked_at") @db.Timestamptz(6)
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("door_unlock_logs")
}

// Package Locker - 10 lockers in package room
model PackageLocker {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  buildingId   String    @map("building_id")
  lockerNumber Int       @map("locker_number") // Locker number (1-10)
  location     String?   @default("Front Door - Package Room") // Location description
  isOccupied   Boolean?  @default(false) @map("is_occupied") // Whether locker is occupied
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  building Building  @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  packages Package[]

  @@unique([buildingId, lockerNumber])
  @@map("package_lockers")
}

// Package - Check-in record for packages
model Package {
  id            String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  buildingId    String    @map("building_id")
  lockerId      String    @map("locker_id") // PackageLocker ID
  householdId   String    @map("household_id") // Linked household
  packageNumber String?   @map("package_number") // Tracking number or reference
  description   String? // Package description
  checkedInAt   DateTime? @default(now()) @map("checked_in_at") @db.Timestamptz(6) // When package was checked in
  checkedOutAt  DateTime? @map("checked_out_at") @db.Timestamptz(6) // When package was picked up
  checkedInBy   String?   @map("checked_in_by") // User ID who checked in the package
  checkedOutBy  String?   @map("checked_out_by") // User ID who picked up the package
  status        String?   @default("pending") // pending, picked_up, expired
  createdAt     DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  building      Building       @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  locker        PackageLocker  @relation(fields: [lockerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  household     Household      @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  notifications Notification[]

  @@map("packages")
}

// Facility - Gym, Meeting Room #1, Meeting Room #2 on 2nd floor
model Facility {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  buildingId  String    @map("building_id")
  floorId     String?   @map("floor_id") // Floor ID (e.g., floor 2)
  floorNumber Int?      @map("floor_number") // Floor number (2)
  name        String // Facility name (e.g., "Gym", "Meeting Room #1", "Meeting Room #2")
  description String? // Facility description
  type        String? // Facility type (gym, meeting_room, etc.)
  capacity    Int? // Maximum capacity
  isActive    Boolean?  @default(true) @map("is_active") // Whether facility is active
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  building       Building                 @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  floor          Floor?                   @relation(fields: [floorId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  operatingHours FacilityOperatingHours[]
  reservations   FacilityReservation[]

  @@unique([buildingId, name])
  @@map("facilities")
}

// Facility Operating Hours - Calendar for operation hours (building admin can edit)
model FacilityOperatingHours {
  id         String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  facilityId String    @map("facility_id")
  dayOfWeek  Int       @map("day_of_week") // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  openTime   String    @map("open_time") // Time in HH:mm format (e.g., "09:00")
  closeTime  String    @map("close_time") // Time in HH:mm format (e.g., "22:00")
  isClosed   Boolean?  @default(false) @map("is_closed") // Whether facility is closed on this day
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([facilityId, dayOfWeek])
  @@map("facility_operating_hours")
}

// Facility Reservation - Members can reserve time slots
model FacilityReservation {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  facilityId     String    @map("facility_id")
  householdId    String    @map("household_id") // Reserving household
  requestedBy    String    @map("requested_by") // User ID who requested
  startTime      DateTime  @map("start_time") @db.Timestamptz(6) // Reservation start time
  endTime        DateTime  @map("end_time") @db.Timestamptz(6) // Reservation end time
  status         String    @default("pending") // pending, approved, rejected, completed, cancelled
  approvedBy     String?   @map("approved_by") // User ID who approved (building admin)
  approvedAt     DateTime? @map("approved_at") @db.Timestamptz(6) // When reservation was approved
  accessCode     String?   @map("access_code") // Access code for entry (generated after approval)
  purpose        String? // Purpose of reservation
  notes          String? // Additional notes
  numberOfPeople Int?      @map("number_of_people") // Number of people planning to attend
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  facility      Facility       @relation(fields: [facilityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  household     Household      @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  notifications Notification[]

  @@index([facilityId, startTime, endTime])
  @@index([householdId])
  @@index([status])
  @@map("facility_reservations")
}

model UserCredentials {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId    String   @unique @map("user_id")
  password  String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("user_credentials")
}

// IoT 設備模型（統一支援 MQTT 和 RESTful API）
// 儲存 IoT 設備資訊（支援 Tuya、ESP、Midea、Philips、Panasonic 等供應商）
model IoTDevice {
  id             String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  deviceId       String        @map("device_id") // 設備 ID（供應商特定）
  name           String // 設備名稱
  vendor         String // 供應商類型（tuya, esp, midea, philips, panasonic）
  connectionType String        @default("mqtt") @map("connection_type") // 連接類型（mqtt, restful, websocket）
  topic          String? // MQTT 主題（MQTT 設備使用）
  commandTopic   String?       @map("command_topic") // 命令主題（MQTT 設備使用）
  statusTopic    String?       @map("status_topic") // 狀態主題（MQTT 設備使用）
  baseUrl        String?       @map("base_url") // RESTful API 基礎 URL（RESTful 設備使用）
  apiKey         String?       @map("api_key") // API 金鑰（RESTful 設備使用）
  accessToken    String?       @map("access_token") // 訪問令牌（RESTful 設備使用）
  householdId    String        @map("household_id") // 所屬家庭
  roomId         String?       @map("room_id") // 所屬房間（可選）
  status         String        @default("offline") // 連接狀態（online/offline）
  state          Json? // 設備狀態（JSON 格式）
  metadata       Json? // 額外元資料
  lastSeen       DateTime?     @map("last_seen") @db.Timestamptz(6) // 最後在線時間
  createdAt      DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  household      Household     @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  room           Room?         @relation(fields: [roomId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  sceneActions   SceneAction[]

  @@unique([householdId, deviceId, vendor]) // 同一家庭內設備 ID 和供應商唯一
  @@index([householdId])
  @@index([vendor])
  @@index([connectionType])
  @@index([status])
  @@map("iot_devices")
}

// 保留舊的 mQTTDevice 模型名稱以向後兼容（已重命名為 IoTDevice）
// Keep old mQTTDevice model name for backward compatibility (renamed to IoTDevice)

// 跨生态链控制 - 自动化规则
// Cross-ecosystem Control - Automation Rules

model AutomationRule {
  id          String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  name        String
  description String?
  householdId String  @map("household_id")
  enabled     Boolean @default(true)

  // 源设备/传感器配置
  // Source device/sensor configuration
  sourceType     String  @map("source_type") // 'device', 'time', 'manual'
  sourceDeviceId String? @map("source_device_id") // 源设备 ID（如果是设备触发）
  sourceProperty String? @map("source_property") // 源设备属性（如 'temperature', 'motion', 'light'）

  // 触发条件
  // Trigger condition
  condition Json // { operator: '>', value: 25, unit: 'celsius' } 或 { operator: '==', value: true } 等

  // 目标动作
  // Target actions
  actions Json // [{ deviceId: '...', vendor: 'panasonic', action: 'power_on', value: {...} }, ...]

  // 防抖/节流配置
  // Debounce/throttle configuration
  debounceMs Int? @default(1000) @map("debounce_ms") // 防抖时间（毫秒）
  throttleMs Int? @map("throttle_ms") // 节流时间（毫秒）

  // 执行统计
  // Execution statistics
  executionCount Int?      @default(0) @map("execution_count")
  lastExecutedAt DateTime? @map("last_executed_at") @db.Timestamptz(6)

  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([householdId])
  @@index([enabled])
  @@index([sourceDeviceId])
  @@map("automation_rules")
}

// 场景管理
// Scene Management

model Scene {
  id          String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  name        String
  description String?
  householdId String  @map("household_id")
  enabled     Boolean @default(true)

  // 场景动作
  // Scene actions
  actions SceneAction[]

  // 场景图标/颜色（可选）
  // Scene icon/color (optional)
  icon  String?
  color String?

  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([householdId])
  @@index([enabled])
  @@map("scenes")
}

model SceneAction {
  id       String @id @default(dbgenerated("(gen_random_uuid())::text"))
  sceneId  String @map("scene_id")
  deviceId String @map("device_id") // IoTDevice ID
  action   String // 'power_on', 'power_off', 'set_temperature', 'set_brightness', etc.
  value    Json? // 动作值（如温度值、亮度值等）
  delayMs  Int?   @default(0) @map("delay_ms") // 延迟执行时间（毫秒）
  order    Int    @default(0) // 执行顺序

  scene  Scene     @relation(fields: [sceneId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  device IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([sceneId])
  @@index([deviceId])
  @@map("scene_actions")
}

model Announcement {
  id         String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  source     String // 'SYSTEM' | 'COMMUNITY' | 'BUILDING'
  sourceId   String?   @map("source_id") // Community ID or Building ID, null for SYSTEM
  title      String
  message    String
  targetType String    @map("target_type") // 'ALL_HOUSEHOLDS' | 'COMMUNITY' | 'BUILDING' | 'SPECIFIC_HOUSEHOLD'
  targetId   String?   @map("target_id") // Community ID, Building ID, or Household ID, null for ALL_HOUSEHOLDS
  createdBy  String    @map("created_by") // User ID who created the announcement
  isActive   Boolean   @default(true) @map("is_active")
  expiresAt  DateTime? @map("expires_at") @db.Timestamptz(6) // Optional expiration date
  createdAt  DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  creator User               @relation(fields: [createdBy], references: [id], onDelete: Cascade, onUpdate: NoAction)
  reads   AnnouncementRead[]

  @@index([source, sourceId])
  @@index([targetType, targetId])
  @@index([isActive, createdAt])
  @@map("announcements")
}

model AnnouncementRead {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  announcementId String    @map("announcement_id")
  userId         String    @map("user_id")
  householdId    String    @map("household_id") // Track which household context it was read in
  readAt         DateTime? @default(now()) @map("read_at") @db.Timestamptz(6)

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  household    Household    @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([announcementId, userId, householdId])
  @@index([userId, householdId])
  @@index([announcementId])
  @@map("announcement_reads")
}

// Conversation - Chat conversation between frontdesk/admin and household
model Conversation {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  householdId String    @map("household_id")
  buildingId  String?   @map("building_id") // Optional: for building-level conversations
  createdBy   String    @map("created_by") // User ID who created the conversation (frontdesk/admin)
  type        String    @default("general") // 'general' | 'mail' | 'package' | 'doorbell' | 'meal' | 'taxi' | 'reservation'
  relatedId   String?   @map("related_id") // Related entity ID (package ID, reservation ID, etc.)
  status      String    @default("active") // 'active' | 'archived' | 'closed'
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  household Household     @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  building  Building?     @relation(fields: [buildingId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  creator   User          @relation("ConversationCreator", fields: [createdBy], references: [id], onDelete: Cascade, onUpdate: NoAction)
  messages  Message[]
  calls     CallSession[]

  @@index([householdId])
  @@index([buildingId])
  @@index([createdBy])
  @@index([type, relatedId])
  @@index([status, updatedAt])
  @@map("conversations")
}

// Message - Individual message in a conversation
model Message {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  conversationId String    @map("conversation_id")
  senderId       String    @map("sender_id") // User ID
  content        String
  messageType    String    @default("text") // 'text' | 'image' | 'file' | 'system'
  metadata       Json? // Additional data (file URL, image URL, etc.)
  readAt         DateTime? @map("read_at") @db.Timestamptz(6) // When message was read
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sender       User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([readAt])
  @@map("messages")
}

// CallSession - Video/audio call session
model CallSession {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  conversationId String    @map("conversation_id")
  initiatorId    String    @map("initiator_id") // User ID who started the call
  callType       String    @default("audio") // 'audio' | 'video'
  status         String    @default("ringing") // 'ringing' | 'answered' | 'ended' | 'missed' | 'rejected'
  startedAt      DateTime? @map("started_at") @db.Timestamptz(6)
  answeredAt     DateTime? @map("answered_at") @db.Timestamptz(6)
  endedAt        DateTime? @map("ended_at") @db.Timestamptz(6)
  duration       Int?      @default(0) // Duration in seconds
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  initiator    User         @relation("CallInitiator", fields: [initiatorId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([conversationId])
  @@index([initiatorId])
  @@index([status, createdAt])
  @@map("call_sessions")
}
