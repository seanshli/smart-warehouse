generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String               @id @default(dbgenerated("(gen_random_uuid())::text"))
  email                String               @unique
  name                 String?
  image                String?
  phone                String?
  contact              String?
  language             String?              @default("en")
  isAdmin              Boolean              @default(false)
  adminRole            String?              @default("SUPERUSER") @map("admin_role") // SUPERUSER, USER_MANAGEMENT, ITEM_MANAGEMENT, HOUSEHOLD_MODIFICATION
  preferences          Json? // User preferences: theme, fontSize, language
  forcePasswordChange  Boolean?             @default(false) @map("force_password_change")
  // Tuya account integration (per member)
  tuyaAccount          String?               @map("tuya_account") // Tuya account (email or phone number)
  tuyaPassword         String?               @map("tuya_password") // Encrypted Tuya password
  tuyaCountryCode      String?               @default("886") @map("tuya_country_code") // Country code for Tuya login (e.g., "886" for Taiwan, "86" for China)
  tuyaAccessToken      String?               @map("tuya_access_token") // Tuya access token (encrypted, temporary)
  tuyaTokenExpiresAt   DateTime?             @map("tuya_token_expires_at") @db.Timestamptz(6) // Token expiration time
  createdAt            DateTime?            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime?            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  accounts             Account[]
  barcodes             Barcode[]
  householdMemberships HouseholdMember[]
  communityMemberships CommunityMember[]
  workingGroupMembers  WorkingGroupMember[]
  itemHistory          ItemHistory[]
  items                Item[]
  notifications        Notification[]
  sessions             Session[]
  credentials          UserCredentials?
  activities           UserActivity[]

  @@map("users")
}

model Account {
  id                  String  @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id             String
  type                String
  provider            String
  provider_account_id String
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String?
  session_state       String?
  users               User    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([provider, provider_account_id])
  @@map("accounts")
}

model Session {
  id            String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  session_token String   @unique
  user_id       String
  expires       DateTime @db.Timestamptz(6)
  users         User     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime @db.Timestamptz(6)

  @@id([identifier, token])
  @@map("verification_tokens")
}

model Community {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  name           String
  description    String?
  address        String?
  city           String?
  district       String?
  country        String?
  latitude       Float?
  longitude      Float?
  invitationCode String?   @unique @default(dbgenerated("(gen_random_uuid())::text")) @map("invitation_code")
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  buildings     Building[]
  members       CommunityMember[]
  workingGroups WorkingGroup[]

  @@map("communities")
}

model Building {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  communityId String    @map("community_id")
  name        String
  description String?
  address     String?
  floorCount  Int?      @map("floor_count")
  unitCount   Int?      @map("unit_count")
  latitude    Float?
  longitude   Float?
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  community  Community   @relation(fields: [communityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  households Household[]

  @@map("buildings")
}

model CommunityMember {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId      String    @map("user_id")
  communityId String    @map("community_id")
  role        String?   @default("MEMBER") // ADMIN, MANAGER, MEMBER, VIEWER
  joinedAt    DateTime? @default(now()) @map("joined_at") @db.Timestamptz(6)

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, communityId])
  @@map("community_members")
}

model WorkingGroup {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  communityId String    @map("community_id")
  name        String
  description String?
  type        String // BUILDING_MANAGER, SECURITY, MAINTENANCE, ADMINISTRATION, etc.
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  community   Community                @relation(fields: [communityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  members     WorkingGroupMember[]
  permissions WorkingGroupPermission[]

  @@map("working_groups")
}

model WorkingGroupMember {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  workingGroupId String    @map("working_group_id")
  userId         String    @map("user_id")
  role           String?   @default("MEMBER") // LEADER, MEMBER
  assignedAt     DateTime? @default(now()) @map("assigned_at") @db.Timestamptz(6)

  workingGroup WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([workingGroupId, userId])
  @@map("working_group_members")
}

model WorkingGroupPermission {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  workingGroupId String    @map("working_group_id")
  permission     String // VIEW, EDIT, ADD, REMOVE, ADD_MEMBER, REVOKE_MEMBER, MANAGE_BUILDING, etc.
  scope          String? // ALL_BUILDINGS, SPECIFIC_BUILDING, SPECIFIC_HOUSEHOLD
  scopeId        String?   @map("scope_id") // Building ID or Household ID if scope is specific
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  workingGroup WorkingGroup @relation(fields: [workingGroupId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([workingGroupId, permission, scope, scopeId])
  @@map("working_group_permissions")
}

model Household {
  id              String            @id @default(dbgenerated("(gen_random_uuid())::text"))
  name            String
  description     String?
  invitationCode  String?           @unique @default(dbgenerated("(gen_random_uuid())::text")) @map("invitation_code")
  // Tuya Home integration
  tuyaHomeId      String?           @unique @map("tuya_home_id") // Tuya Home ID (對應到 Tuya SDK 的 Home)
  // Building relationship (new)
  buildingId      String?           @map("building_id")
  // Location fields
  country         String?
  city            String?
  district        String?
  community       String? // Legacy field, kept for backward compatibility
  apartmentNo     String?           @map("apartment_no")
  latitude        Float?
  longitude       Float?
  address         String?
  streetAddress   String?           @map("street_address")
  buildingAddress String?           @map("building_address")
  telephone       String?
  createdAt       DateTime?         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime?         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  categories      Category[]
  members         HouseholdMember[]
  items           Item[]
  rooms           Room[]
  activities      UserActivity[]
  iotDevices      IoTDevice[] // IoT 設備（統一支援 MQTT 和 RESTful API）
  building        Building?         @relation(fields: [buildingId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@map("households")
}

model HouseholdMember {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId      String    @map("user_id")
  householdId String    @map("household_id")
  role        String?   @default("USER")
  joinedAt    DateTime? @default(now()) @map("joined_at") @db.Timestamptz(6)
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, householdId])
  @@map("household_members")
}

model Room {
  id             String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name           String
  description    String?
  householdId    String         @map("household_id")
  createdAt      DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  cabinets       Cabinet[]
  newItemHistory ItemHistory[]  @relation("ItemHistoryNewRoom")
  oldItemHistory ItemHistory[]  @relation("ItemHistoryOldRoom")
  items          Item[]
  activities     UserActivity[]
  iotDevices     IoTDevice[] // IoT 設備（統一支援 MQTT 和 RESTful API）
  household      Household      @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("rooms")
}

model Cabinet {
  id             String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name           String
  description    String?
  roomId         String         @map("room_id")
  createdAt      DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  room           Room           @relation(fields: [roomId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  newItemHistory ItemHistory[]  @relation("ItemHistoryNewCabinet")
  oldItemHistory ItemHistory[]  @relation("ItemHistoryOldCabinet")
  items          Item[]
  activities     UserActivity[]

  @@map("cabinets")
}

model Category {
  id          String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name        String
  description String?
  level       Int
  parentId    String?        @map("parent_id")
  householdId String         @map("household_id")
  createdAt   DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  household   Household      @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  parent      Category?      @relation("CategoryHierarchy", fields: [parentId], references: [id], onUpdate: NoAction)
  children    Category[]     @relation("CategoryHierarchy")
  items       Item[]
  activities  UserActivity[]

  @@map("categories")
}

model Item {
  id            String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  name          String
  description   String?
  quantity      Int            @default(1)
  minQuantity   Int?           @default(0) @map("min_quantity")
  image_url     String?
  barcode       String?
  qr_code       String?
  categoryId    String?        @map("category_id")
  roomId        String?        @map("room_id")
  cabinetId     String?        @map("cabinet_id")
  householdId   String         @map("household_id")
  addedById     String         @map("added_by_id")
  createdAt     DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  qrCode        String?
  imageUrl      String?
  aiDescription String?
  language      String?        @map("language")
  buyDate       DateTime?      @map("buy_date") @db.Timestamp(6)
  buyCost       Float?         @map("buy_cost") @db.Real
  buyLocation   String?        @map("buy_location")
  invoiceNumber String?        @map("invoice_number")
  sellerName    String?        @map("seller_name")
  tags          String[]       @default([])
  history       ItemHistory[]
  addedBy       User           @relation(fields: [addedById], references: [id], onDelete: Cascade, onUpdate: NoAction)
  cabinet       Cabinet?       @relation(fields: [cabinetId], references: [id], onUpdate: NoAction)
  category      Category?      @relation(fields: [categoryId], references: [id], onUpdate: NoAction)
  household     Household      @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  room          Room?          @relation(fields: [roomId], references: [id], onUpdate: NoAction)
  notifications Notification[]
  activities    UserActivity[]

  @@map("items")
}

model ItemHistory {
  id              String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  itemId          String    @map("item_id")
  action          String
  description     String?
  voiceUrl        String?   @map("voice_url")
  voiceTranscript String?   @map("voice_transcript")
  performedBy     String    @map("performed_by")
  oldRoomId       String?   @map("old_room_id")
  newRoomId       String?   @map("new_room_id")
  oldCabinetId    String?   @map("old_cabinet_id")
  newCabinetId    String?   @map("new_cabinet_id")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  item            Item      @relation(fields: [itemId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  newCabinet      Cabinet?  @relation("ItemHistoryNewCabinet", fields: [newCabinetId], references: [id], onUpdate: NoAction)
  newRoom         Room?     @relation("ItemHistoryNewRoom", fields: [newRoomId], references: [id], onUpdate: NoAction)
  oldCabinet      Cabinet?  @relation("ItemHistoryOldCabinet", fields: [oldCabinetId], references: [id], onUpdate: NoAction)
  oldRoom         Room?     @relation("ItemHistoryOldRoom", fields: [oldRoomId], references: [id], onUpdate: NoAction)
  performer       User      @relation(fields: [performedBy], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("item_history")
}

model UserActivity {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId       String    @map("user_id")
  householdId  String    @map("household_id")
  activityType String    @map("activity_type") // 'search', 'view_item', 'view_location', 'view_category', 'navigate', 'filter', etc.
  action       String // 'search_items', 'view_item_detail', 'view_room', 'view_cabinet', 'view_category', 'filter_by_category', etc.
  metadata     Json? // Store search query, item ID, location ID, category ID, filter params, etc.
  description  String? // Human-readable description
  itemId       String?   @map("item_id")
  roomId       String?   @map("room_id")
  cabinetId    String?   @map("cabinet_id")
  categoryId   String?   @map("category_id")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  household    Household @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  item         Item?     @relation(fields: [itemId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  room         Room?     @relation(fields: [roomId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  cabinet      Cabinet?  @relation(fields: [cabinetId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  category     Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([userId, householdId, createdAt])
  @@index([householdId, activityType, createdAt])
  @@map("user_activities")
}

model Barcode {
  id           String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  user_id      String
  barcode      String
  product_name String?
  description  String?
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  users        User      @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("barcodes")
}

model Notification {
  id        String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId    String    @map("user_id")
  itemId    String?   @map("item_id")
  type      String
  title     String
  message   String
  read      Boolean?  @default(false)
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  item      Item?     @relation(fields: [itemId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("notifications")
}

model UserCredentials {
  id        String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId    String   @unique @map("user_id")
  password  String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("user_credentials")
}

// IoT 設備模型（統一支援 MQTT 和 RESTful API）
// 儲存 IoT 設備資訊（支援 Tuya、ESP、Midea、Philips、Panasonic 等供應商）
model IoTDevice {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  deviceId       String    @map("device_id") // 設備 ID（供應商特定）
  name           String // 設備名稱
  vendor         String // 供應商類型（tuya, esp, midea, philips, panasonic）
  connectionType String    @default("mqtt") @map("connection_type") // 連接類型（mqtt, restful, websocket）
  topic          String? // MQTT 主題（MQTT 設備使用）
  commandTopic   String?   @map("command_topic") // 命令主題（MQTT 設備使用）
  statusTopic    String?   @map("status_topic") // 狀態主題（MQTT 設備使用）
  baseUrl        String?   @map("base_url") // RESTful API 基礎 URL（RESTful 設備使用）
  apiKey         String?   @map("api_key") // API 金鑰（RESTful 設備使用）
  accessToken    String?   @map("access_token") // 訪問令牌（RESTful 設備使用）
  householdId    String    @map("household_id") // 所屬家庭
  roomId         String?   @map("room_id") // 所屬房間（可選）
  status         String    @default("offline") // 連接狀態（online/offline）
  state          Json? // 設備狀態（JSON 格式）
  metadata       Json? // 額外元資料
  lastSeen       DateTime? @map("last_seen") @db.Timestamptz(6) // 最後在線時間
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  household      Household @relation(fields: [householdId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  room           Room?     @relation(fields: [roomId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@unique([householdId, deviceId, vendor]) // 同一家庭內設備 ID 和供應商唯一
  @@index([householdId])
  @@index([vendor])
  @@index([connectionType])
  @@index([status])
  @@map("iot_devices")
}

// 保留舊的 mQTTDevice 模型名稱以向後兼容（已重命名為 IoTDevice）
// Keep old mQTTDevice model name for backward compatibility (renamed to IoTDevice)
